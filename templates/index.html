<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Voyager Bridge</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #f4f4f4; padding: 20px; border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="password"], input[type="number"], select {
            width: 95%; padding: 10px; border: 1px solid #ddd; border-radius: 3px;
        }
        button { padding: 10px 15px; background: #333; color: #fff; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px; }
        button:hover { background: #555; }
        .hidden { display: none; }
        #status, #result { margin-top: 15px; padding: 10px; border: 1px solid #ddd; background: #fff; }
        #columnsDiv label { display: inline-block; margin-right: 10px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Data Voyager Bridge</h1>
        <p>Ingest data between ClickHouse and Flat Files.</p>

        <div class="form-group">
            <label for="flowType">Select Flow:</label>
            <select id="flowType" name="flowType">
                <option value="ch_to_ff">ClickHouse -> Flat File</option>
                <option value="ff_to_ch">Flat File -> ClickHouse</option>
            </select>
        </div>

        <hr>

        <!-- ClickHouse Source Configuration -->
        <div id="chSourceConfig">
            <h3>ClickHouse Source Configuration</h3>
            <div class="form-group">
                <label for="chSourceHost">Host:</label>
                <input type="text" id="chSourceHost" name="chSourceHost" placeholder="e.g., localhost">
            </div>
            <div class="form-group">
                <label for="chSourcePort">Port:</label>
                <input type="number" id="chSourcePort" name="chSourcePort" placeholder="e.g., 8123 / 8443 / 9000 / 9440">
            </div>
             <div class="form-group">
                <label for="chSourceSecure">Secure (HTTPS/Native Secure):</label>
                <input type="checkbox" id="chSourceSecure" name="chSourceSecure">
            </div>
            <div class="form-group">
                <label for="chSourceDb">Database:</label>
                <input type="text" id="chSourceDb" name="chSourceDb" placeholder="e.g., default">
            </div>
            <div class="form-group">
                <label for="chSourceUser">User:</label>
                <input type="text" id="chSourceUser" name="chSourceUser" placeholder="e.g., default">
            </div>
            <div class="form-group">
                <label for="chSourceJwt">JWT Token (Optional, for specific auth):</label>
                <input type="password" id="chSourceJwt" name="chSourceJwt">
             </div>
             <div class="form-group">
                 <label for="chSourcePassword">Password (if not using JWT):</label>
                 <input type="password" id="chSourcePassword" name="chSourcePassword">
            </div>
            <button id="connectChSourceBtn">Connect & Load Tables</button>
            <div class="form-group">
                <label for="chSourceTable">Select Table:</label>
                <select id="chSourceTable" name="chSourceTable" class="hidden"></select>
            </div>
        </div>

        <!-- Flat File Source Configuration -->
        <div id="ffSourceConfig" class="hidden">
            <h3>Flat File Source Configuration</h3>
            <div class="form-group">
                <label for="ffSourceFile">Local File Path:</label>
                <input type="text" id="ffSourceFile" name="ffSourceFile" placeholder="e.g., /path/to/your/data.csv">
            </div>
            <div class="form-group">
                <label for="ffSourceDelimiter">Delimiter:</label>
                <input type="text" id="ffSourceDelimiter" name="ffSourceDelimiter" value=",">
            </div>
             <div class="form-group">
                 <label for="ffSourceHeader">File has header row:</label>
                 <input type="checkbox" id="ffSourceHeader" name="ffSourceHeader" checked>
            </div>
            <button id="loadFfSourceColumnsBtn">Load Columns from File</button>
        </div>

        <hr>

        <!-- ClickHouse Target Configuration -->
         <div id="chTargetConfig" class="hidden">
            <h3>ClickHouse Target Configuration</h3>
             <p><i>Uses the same connection details as Source if Flow is Flat File -> ClickHouse. Define Table below.</i></p>
             <div class="form-group">
                 <label for="chTargetTable">Target Table Name:</label>
                 <input type="text" id="chTargetTable" name="chTargetTable" placeholder="e.g., imported_data">
             </div>
             <div class="form-group">
                 <label for="chTargetCreate">Create Table if Not Exists:</label>
                 <input type="checkbox" id="chTargetCreate" name="chTargetCreate" checked>
             </div>
         </div>

        <!-- Flat File Target Configuration -->
        <div id="ffTargetConfig">
             <h3>Flat File Target Configuration</h3>
             <div class="form-group">
                 <label for="ffTargetFile">Local File Path:</label>
                 <input type="text" id="ffTargetFile" name="ffTargetFile" placeholder="e.g., /path/to/output/data.csv">
             </div>
             <div class="form-group">
                 <label for="ffTargetDelimiter">Delimiter:</label>
                 <input type="text" id="ffTargetDelimiter" name="ffTargetDelimiter" value=",">
             </div>
             <div class="form-group">
                 <label for="ffTargetHeader">Include header row:</label>
                 <input type="checkbox" id="ffTargetHeader" name="ffTargetHeader" checked>
             </div>
         </div>

        <hr>

        <!-- Column Selection -->
        <div id="columnSelection" class="hidden">
            <h3>Select Columns for Ingestion</h3>
             <button id="selectAllColsBtn">Select All</button> <button id="deselectAllColsBtn">Deselect All</button>
            <div id="columnsDiv">
                <!-- Columns will be populated here -->
            </div>
        </div>

        <hr>

        <!-- Actions -->
        <button id="startIngestionBtn" class="hidden">Start Ingestion</button>

        <!-- Status & Result -->
        <div id="status">Status: Idle</div>
        <div id="result">Result:</div>

    </div>

    <script>
        const flowTypeSelect = document.getElementById('flowType');
        const chSourceConfigDiv = document.getElementById('chSourceConfig');
        const ffSourceConfigDiv = document.getElementById('ffSourceConfig');
        const chTargetConfigDiv = document.getElementById('chTargetConfig');
        const ffTargetConfigDiv = document.getElementById('ffTargetConfig');
        const columnSelectionDiv = document.getElementById('columnSelection');
        const columnsDiv = document.getElementById('columnsDiv');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const startIngestionBtn = document.getElementById('startIngestionBtn');
        const connectChSourceBtn = document.getElementById('connectChSourceBtn');
        const chSourceTableSelect = document.getElementById('chSourceTable');
        const loadFfSourceColumnsBtn = document.getElementById('loadFfSourceColumnsBtn');
        const selectAllColsBtn = document.getElementById('selectAllColsBtn');
        const deselectAllColsBtn = document.getElementById('deselectAllColsBtn');


        function updateUIForFlow() {
            const selectedFlow = flowTypeSelect.value;
            resetStatus();
            hideElement(chSourceTableSelect);
            hideElement(columnSelectionDiv);
            hideElement(startIngestionBtn);
            columnsDiv.innerHTML = ''; // Clear previous columns

            if (selectedFlow === 'ch_to_ff') {
                showElement(chSourceConfigDiv);
                hideElement(ffSourceConfigDiv);
                hideElement(chTargetConfigDiv);
                showElement(ffTargetConfigDiv);
            } else { // ff_to_ch
                hideElement(chSourceConfigDiv);
                showElement(ffSourceConfigDiv);
                showElement(chTargetConfigDiv);
                hideElement(ffTargetConfigDiv);
            }
        }

        function setStatus(message, isError = false) {
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.className = isError ? 'error' : '';
            console.log(`Status: ${message}`);
        }

        function setResult(message, isError = false) {
            resultDiv.textContent = `Result: ${message}`;
            resultDiv.className = isError ? 'error' : 'success';
             console.log(`Result: ${message}`);
        }

        function resetStatus() {
            setStatus("Idle");
            setResult("");
            resultDiv.className = '';
            statusDiv.className = '';
        }

        function hideElement(el) {
            if (el && !el.classList.contains('hidden')) {
                el.classList.add('hidden');
            }
        }

        function showElement(el) {
             if (el && el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            }
        }

        function getChSourceCredentials() {
             const host = document.getElementById('chSourceHost').value;
             const port = document.getElementById('chSourcePort').value;
             const secure = document.getElementById('chSourceSecure').checked;
             const database = document.getElementById('chSourceDb').value;
             const user = document.getElementById('chSourceUser').value;
             const jwt = document.getElementById('chSourceJwt').value;
             const password = document.getElementById('chSourcePassword').value;

             if (!host || !port || !database || !user || (!jwt && !password)) {
                setStatus('Missing ClickHouse connection details', true);
                return null;
             }
             return { host, port: parseInt(port), secure, database, user, jwt, password };
        }

        function displayColumns(columns) {
            columnsDiv.innerHTML = ''; // Clear previous
            if (!columns || columns.length === 0) {
                columnsDiv.innerHTML = '<p>No columns found or unable to load.</p>';
                hideElement(startIngestionBtn);
                 hideElement(columnSelectionDiv);
                return;
            }
            columns.forEach(col => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col_${col}`;
                checkbox.name = 'columns';
                checkbox.value = col;
                checkbox.checked = true; // Select by default

                const label = document.createElement('label');
                label.htmlFor = `col_${col}`;
                label.appendChild(document.createTextNode(col));

                const div = document.createElement('div');
                div.appendChild(checkbox);
                div.appendChild(label);
                columnsDiv.appendChild(div);
            });
            showElement(columnSelectionDiv);
            showElement(startIngestionBtn);
        }

        function getSelectedColumns() {
            const selected = [];
            document.querySelectorAll('#columnsDiv input[type="checkbox"]:checked').forEach(cb => {
                selected.push(cb.value);
            });
            return selected;
        }

         function toggleAllColumns(select) {
            document.querySelectorAll('#columnsDiv input[type="checkbox"]').forEach(cb => {
                cb.checked = select;
            });
        }


        // --- Event Listeners ---

        flowTypeSelect.addEventListener('change', updateUIForFlow);

        connectChSourceBtn.addEventListener('click', async () => {
            const credentials = getChSourceCredentials();
            if (!credentials) return;

            setStatus('Connecting to ClickHouse and fetching tables...');
            hideElement(chSourceTableSelect);
            hideElement(columnSelectionDiv);
            hideElement(startIngestionBtn);


            try {
                const response = await fetch('/get_tables', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentials)
                });

                const data = await response.json();

                if (response.ok && data.tables) {
                    setStatus('Connected. Select a table.');
                    chSourceTableSelect.innerHTML = '<option value="">-- Select Table --</option>'; // Reset
                    data.tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        chSourceTableSelect.appendChild(option);
                    });
                    showElement(chSourceTableSelect);
                } else {
                    setStatus(`Error fetching tables: ${data.error || 'Unknown error'}`, true);
                     setResult('');
                }
            } catch (error) {
                setStatus(`Network or server error: ${error}`, true);
                setResult('');
            }
        });

         chSourceTableSelect.addEventListener('change', async () => {
            const credentials = getChSourceCredentials();
            const tableName = chSourceTableSelect.value;
             if (!credentials || !tableName) {
                 hideElement(columnSelectionDiv);
                 hideElement(startIngestionBtn);
                 return;
             };

            setStatus(`Fetching columns for table ${tableName}...`);
            hideElement(columnSelectionDiv);
            hideElement(startIngestionBtn);


            try {
                const response = await fetch('/get_columns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...credentials, table: tableName, source_type: 'clickhouse' })
                });

                const data = await response.json();

                if (response.ok && data.columns) {
                    setStatus('Columns loaded. Select columns to ingest.');
                    displayColumns(data.columns);
                } else {
                     setStatus(`Error fetching columns: ${data.error || 'Unknown error'}`, true);
                     setResult('');
                     displayColumns([]); // Clear columns display
                }
            } catch (error) {
                setStatus(`Network or server error fetching columns: ${error}`, true);
                setResult('');
                displayColumns([]); // Clear columns display
            }
        });

        loadFfSourceColumnsBtn.addEventListener('click', async () => {
            const filePath = document.getElementById('ffSourceFile').value;
            const delimiter = document.getElementById('ffSourceDelimiter').value;
            const hasHeader = document.getElementById('ffSourceHeader').checked;


            if (!filePath || !delimiter) {
                setStatus('Missing Flat File path or delimiter', true);
                return;
            }
            if (!hasHeader) {
                 setStatus('Cannot automatically detect columns without a header row.', true);
                 setResult('Please ensure the target ClickHouse table exists or manually define schema.');
                 // Allow proceeding but without column selection UI
                 displayColumns([]); // Clear/hide column UI
                 showElement(startIngestionBtn); // Allow proceeding
                 return;
            }


            setStatus(`Loading columns from ${filePath}...`);
            hideElement(columnSelectionDiv);
            hideElement(startIngestionBtn);

            try {
                const response = await fetch('/get_columns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_type: 'flatfile',
                        file_path: filePath,
                        delimiter: delimiter,
                        has_header: hasHeader
                     })
                });

                const data = await response.json();

                if (response.ok && data.columns) {
                    setStatus('Columns loaded from file header. Select columns to ingest.');
                    displayColumns(data.columns);
                } else {
                    setStatus(`Error loading columns from file: ${data.error || 'Unknown error'}`, true);
                     setResult('');
                     displayColumns([]);
                }
            } catch (error) {
                setStatus(`Network or server error loading columns: ${error}`, true);
                setResult('');
                displayColumns([]);
            }
        });

        selectAllColsBtn.addEventListener('click', () => toggleAllColumns(true));
        deselectAllColsBtn.addEventListener('click', () => toggleAllColumns(false));


        startIngestionBtn.addEventListener('click', async () => {
            setStatus('Starting ingestion...');
            setResult('');
            hideElement(startIngestionBtn); // Prevent double clicks

            const flowType = flowTypeSelect.value;
            const selectedColumns = getSelectedColumns();
            let payload = { flow_type: flowType, columns: selectedColumns };

            try {
                 // --- Gather Common Config ---
                if (flowType === 'ch_to_ff') {
                    const chCreds = getChSourceCredentials();
                    const sourceTable = chSourceTableSelect.value;
                    const targetFile = document.getElementById('ffTargetFile').value;
                    const targetDelimiter = document.getElementById('ffTargetDelimiter').value;
                    const includeHeader = document.getElementById('ffTargetHeader').checked;

                    if (!chCreds || !sourceTable || !targetFile || !targetDelimiter) {
                        throw new Error("Missing required configuration for ClickHouse -> Flat File flow.");
                    }
                     if (selectedColumns.length === 0) {
                        throw new Error("No columns selected for ingestion.");
                    }

                    payload = { ...payload, ...chCreds, source_table: sourceTable, target_file: targetFile, target_delimiter: targetDelimiter, include_header: includeHeader };

                } else { // ff_to_ch
                     const sourceFile = document.getElementById('ffSourceFile').value;
                     const sourceDelimiter = document.getElementById('ffSourceDelimiter').value;
                     const sourceHasHeader = document.getElementById('ffSourceHeader').checked;
                     const targetTable = document.getElementById('chTargetTable').value;
                     const targetCreate = document.getElementById('chTargetCreate').checked;
                     const chCreds = getChSourceCredentials(); // Get CH creds (required for target)

                    if (!sourceFile || !sourceDelimiter || !targetTable || !chCreds) {
                         throw new Error("Missing required configuration for Flat File -> ClickHouse flow.");
                    }
                     // If no header, columns *must* match target table or be specified manually (future enhancement)
                     // For now, we rely on the selected columns derived from the header if available.
                     if (sourceHasHeader && selectedColumns.length === 0) {
                        throw new Error("No columns selected for ingestion (from header).");
                    }
                     if (!sourceHasHeader && selectedColumns.length > 0) {
                        // This case shouldn't happen with current UI logic, but good to check
                         console.warn("Columns selected but source file has no header. Ingestion might fail if target schema doesn't match.");
                    }


                    payload = { ...payload, ...chCreds, source_file: sourceFile, source_delimiter: sourceDelimiter, source_has_header: sourceHasHeader, target_table: targetTable, target_create: targetCreate };
                }

                // --- Send Request ---
                setStatus('Ingesting data...');
                const response = await fetch('/ingest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    setStatus('Ingestion completed successfully.');
                    setResult(`Records processed: ${data.records_processed}`);
                } else {
                     setStatus(`Ingestion failed: ${data.error || 'Unknown server error'}`, true);
                     setResult('');
                }

            } catch (error) {
                setStatus(`Ingestion failed: ${error.message || error}`, true);
                 setResult('');
            } finally {
                 // Re-enable button only if columns are still displayed (meaning config is likely still valid)
                 if (!columnSelectionDiv.classList.contains('hidden')) {
                    showElement(startIngestionBtn);
                 }
            }
        });

        // Initial UI setup
        updateUIForFlow();

    </script>
</body>
</html> 